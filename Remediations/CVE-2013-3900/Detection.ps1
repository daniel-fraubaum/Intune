# Detection.ps1
# Name: CVE-2013-3900
# Hive: HKLM
# Date: 2025-10-27

# Exit 0 => Compliant; Exit 1 => Not compliant
# Any mismatch or missing path/value will trigger remediation.
$errors = @()

function Test-RegistryValue {
  param(
    [Parameter(Mandatory=$true)][string]$Path,
    [Parameter(Mandatory=$true)][string]$Name,
    [Parameter(Mandatory=$true)][ValidateSet('REG_SZ','REG_DWORD')][string]$Type,
    [Parameter()][string]$Expected
  )
  if (-not (Test-Path -LiteralPath $Path)) { return $false }
  $val = $null
  try { $val = Get-ItemPropertyValue -LiteralPath $Path -Name $Name -ErrorAction SilentlyContinue } catch {}
  if ($null -eq $val) { return $false }
  if ($Type -eq 'REG_DWORD') { try { return ($val -eq [int]$Expected) } catch { return $false } }
  else { return ([string]$val -eq [string]$Expected) }
}

# [1] SET/UPDATE
if (-not (Test-Path -LiteralPath 'HKLM:\Software\Microsoft\Cryptography\Wintrust\Config')) {
  $errors += 'Missing key: HKLM:\Software\Microsoft\Cryptography\Wintrust\Config'
} else {
  if (-not (Test-RegistryValue -Path 'HKLM:\Software\Microsoft\Cryptography\Wintrust\Config' -Name 'EnableCertPaddingCheck' -Type 'REG_DWORD' -Expected '1')) {
    $errors += 'Mismatch: HKLM:\Software\Microsoft\Cryptography\Wintrust\Config :: EnableCertPaddingCheck'
  }
}

# [2] DELETE value if present
if (Test-Path -LiteralPath 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config') {
  $exists = $false
  try { $exists = $null -ne (Get-ItemProperty -LiteralPath 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config' -Name 'EnableCertPaddingCheck' -ErrorAction SilentlyContinue) } catch {}
  if ($exists) { $errors += 'Value exists: HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config :: EnableCertPaddingCheck' }
}

if ($errors.Count -gt 0) { exit 1 } else { exit 0 }
