# Remediation.ps1
# Name: CVE-2013-3900
# Hive: HKLM
# Date: 2025-10-27

# Applies desired state. Safe to re-run.

function Ensure-Key {
  param([Parameter(Mandatory=$true)][string]$Path)
  if (-not (Test-Path -LiteralPath $Path)) { New-Item -Path $Path -Force | Out-Null }
}

function Ensure-Value {
  param(
    [Parameter(Mandatory=$true)][string]$Path,
    [Parameter(Mandatory=$true)][string]$Name,
    [Parameter(Mandatory=$true)][ValidateSet('REG_SZ','REG_DWORD')][string]$Type,
    [Parameter()][string]$Value
  )
  Ensure-Key -Path $Path
  $exists = $false
  try { $tmp = Get-ItemProperty -LiteralPath $Path -Name $Name -ErrorAction SilentlyContinue; $exists = $null -ne $tmp } catch {}
  if (-not $exists) {
    if ($Type -eq 'REG_DWORD') {
      New-ItemProperty -LiteralPath $Path -Name $Name -Value ([int]$Value) -PropertyType DWord -Force | Out-Null
    } else {
      New-ItemProperty -LiteralPath $Path -Name $Name -Value $Value -PropertyType String -Force | Out-Null
    }
  } else {
    if ($Type -eq 'REG_DWORD') {
      Set-ItemProperty -LiteralPath $Path -Name $Name -Value ([int]$Value) -Force
    } else {
      Set-ItemProperty -LiteralPath $Path -Name $Name -Value $Value -Force
    }
  }
}

# [1] SET/UPDATE value
Ensure-Value -Path 'HKLM:\Software\Microsoft\Cryptography\Wintrust\Config' -Name 'EnableCertPaddingCheck' -Type 'REG_DWORD' -Value 1

# [2] DELETE value (if exists)
if (Test-Path -LiteralPath 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config') {
  try { Remove-ItemProperty -LiteralPath 'HKLM:\Software\Wow6432Node\Microsoft\Cryptography\Wintrust\Config' -Name 'EnableCertPaddingCheck' -ErrorAction SilentlyContinue } catch {}
}
